name: Build Android Release (AAB & APK)

on:
  push:
    branches:
      - release/1.0
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or commit) to build. Default: release/1.0'
        required: false
        default: 'release/1.0'

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'release/1.0' }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Decode Android keystore (from secrets)
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Decoding keystore from secrets"
            mkdir -p android/app
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          else
            echo "No keystore secret provided; skipping decode"
          fi

      - name: Create key.properties (from secrets)
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_PASSWORD" ] && [ -n "$ANDROID_KEY_PASSWORD" ] && [ -n "$ANDROID_KEY_ALIAS" ]; then
            cat <<'EOF' > android/key.properties
            storePassword=$ANDROID_KEYSTORE_PASSWORD
            keyPassword=$ANDROID_KEY_PASSWORD
            keyAlias=$ANDROID_KEY_ALIAS
            storeFile=upload-keystore.jks
            EOF
          else
            echo "No signing secrets provided; will generate temporary keystore if needed"
          fi

      - name: Generate temporary keystore (fallback if no secrets)
        run: |
          echo "Generating temporary keystore (no secrets provided)"
          mkdir -p android/app
          # Only generate if keystore does not already exist
          if [ -f android/app/upload-keystore.jks ]; then
            echo "Keystore already present; skipping generation"
          else
            TEMP_STORE_PASS=$(openssl rand -base64 16 | tr -d '\n' )
            TEMP_KEY_PASS=$(openssl rand -base64 16 | tr -d '\n' )
          TEMP_ALIAS="pillcare_upload"
          echo "Using alias: $TEMP_ALIAS"
          keytool -genkeypair -v \
            -keystore android/app/upload-keystore.jks \
            -storetype JKS \
            -storepass "$TEMP_STORE_PASS" \
            -keypass "$TEMP_KEY_PASS" \
            -alias "$TEMP_ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 3650 \
            -dname "CN=PillCare, OU=Android, O=Technion, L=Haifa, S=Haifa, C=IL"
          printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=upload-keystore.jks\n" "$TEMP_STORE_PASS" "$TEMP_KEY_PASS" "$TEMP_ALIAS" > android/key.properties
          # Save the keystore and credentials as artifacts so you can store them securely for future releases
          echo "$TEMP_STORE_PASS" > tmp_store_password.txt
          echo "$TEMP_KEY_PASS" > tmp_key_password.txt
          echo "$TEMP_ALIAS" > tmp_key_alias.txt
          fi
        shell: bash

      - name: Flutter pub get
        run: flutter pub get

      - name: Build AAB (release)
        run: flutter build appbundle --release

      - name: Build APK (release)
        run: flutter build apk --release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ github.run_number }}
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/flutter-apk/app-release.apk
            android/app/upload-keystore.jks
            tmp_store_password.txt
            tmp_key_password.txt
            tmp_key_alias.txt

      - name: Commit artifacts into repo (dist/)
        run: |
          mkdir -p dist
          cp build/app/outputs/bundle/release/app-release.aab dist/
          cp build/app/outputs/flutter-apk/app-release.apk dist/
          # Do NOT commit keystore or passwords into repo for security.
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add dist
          if git diff --cached --quiet; then echo "No changes to commit"; else git commit -m "ci: add release artifacts (run $GITHUB_RUN_NUMBER)"; git push; fi
        shell: bash
